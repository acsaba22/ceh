#!/bin/bash -e

. /opt/ceh/scripts/common-functions.sh

# firefox17Wrapper (because of flash), googletalkplugin and java are
# not free software, so they are not distributed in the binary cache
# of nix.  Therefore we can't install them from there, so we use the
# ceh_nix_instantiate_with stuff to build them.
#
# This is a 32-bit FF install (working on both amd64 and i686) with
# all the 3 required plugins:
#  - google talk,
#  - java,
#  - flash,
# please make sure to remove all the conflicting plugins from your
# system (~/.mozilla/firefox/plugins, /usr/lib/mozilla, etc.).
#
# To make sure everything is OK, use all 3 plugins while running
# firefox from a terminal and watch stderr.
#
# Do not ever mix 64-bit plugins with this 32-bit firefox!

[ -e /nix/store/byzd8468l3pq9y7x0dxlfrzg92n5h8mx-firefox-17.0.1-with-plugins.drv ] || {
    ceh_nix_instantiate_with firefox17Wrapper 1.0pre22969_d068aa9
    $CEH_NIX/bin/nix-store -r /nix/store/byzd8468l3pq9y7x0dxlfrzg92n5h8mx-firefox-17.0.1-with-plugins.drv
}
[ -e /nix/store/vgdrl7bj4aqwmdkvdbpa0y8mlch1ai6n-google-talk-plugin-3.10.2.0.drv ] || {
    ceh_nix_instantiate_with google_talk_plugin 1.0pre22969_d068aa9
    $CEH_NIX/bin/nix-store -r /nix/store/vgdrl7bj4aqwmdkvdbpa0y8mlch1ai6n-google-talk-plugin-3.10.2.0.drv
}
[ -e /nix/store/zsa9p8c0iap8lyncrq29a07gjfggaps5-jdk-1.6.0_38b04.drv ] || {
    ceh_nix_instantiate_with jrePlugin 1.0pre22969_d068aa9
    $CEH_NIX/bin/nix-store -r /nix/store/zsa9p8c0iap8lyncrq29a07gjfggaps5-jdk-1.6.0_38b04.drv
}

ceh_nix_install /nix/store/x6wd4c166565dx4w9a1dds2vzsq9z5za-firefox-17.0.1-with-plugins
ceh_nix_install /nix/store/xl95pvsjynnswx570vws6k3lw3vhc6n0-google-talk-plugin-3.10.2.0
ceh_nix_install /nix/store/x36ww9lfnszi0jiy1f8w8w5q9q3bi9rf-jdk-1.6.0_38b04

export MOZ_PLUGIN_PATH=/opt/ceh/home/.nix-profile/jre/lib/i386/plugins:/opt/ceh/home/.nix-profile/lib/mozilla/plugins
export LD_PRELOAD=/opt/ceh/home/.nix-profile/libexec/google/talkplugin//libpreload.so:$LD_PRELOAD

exec /opt/ceh/home/.nix-profile/bin/firefox "$@"
